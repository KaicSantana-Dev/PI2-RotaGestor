<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RotaGestor - Manutenção</title>
  <link rel="stylesheet" href="./styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <link rel="icon" href="../../../../public/assets/logo/Icon.svg">
</head>

<body p-0 m-0>
  <nav>
    <div class="logo">
      <img src="assets/Logo.svg">
    </div>
    <div class="navbar">
      <a href="/"><i class="icon fa-solid fa-house"></i>Início</a>
      <a href="/combustivel"><i class="icon fa-solid fa-gas-pump"></i>Combustivel</a>
      <a href="#"><i class="icon fa-solid fa-wrench"></i>Manutenção</a>
      <a href="/veiculos"><i class="icon fa-solid fa-car"></i> Veículos</a>
      <a href="/pessoas"><i class="icon fa-solid fa-user"></i>Pessoas</a>
    </div>
  </nav>

  <main>
    <header>
      <h1>Manutenções</h1>

      <div class="account-header">
        <div>
          <i class="fa-solid fa-user"></i>
          <span onclick="window.location.href='../../../../index.html'">Sair</span>
        </div>
        <i class="fa-solid fa-gear"></i>
        <i class="fa-solid fa-bell"></i>
      </div>
    </header>

    <section>
      <div class="filtro-container">
        <div class="filtro-item">
          <label>Modelo</label>
          <input type="text" placeholder="Sandero">
        </div>

        <div class="filtro-item">
          <label>Placa</label>
          <input type="text" placeholder="AB4C-4D5H">
        </div>

        <div class="filtro-item">
          <label>Serviços</label>
          <select>
            <option>Manutenção Geral</option>
            <option>Manutenção Elétrica</option>
          </select>
        </div>

        <div class="filtro-item">
          <label>Local</label>
          <input type="text" placeholder="Ex: Mecânica do Tião">
        </div>

        <div class="filtro-item">
          <label>Data</label>
          <input type="date">
        </div>

        <div class="filtro-item">
          <button class="btn" id="btnCadastrar" onclick="abrirModal()">
            <img src="assets/document-icon.svg" alt="Documento" class="">
            Cadastrar
          </button>
        </div>
      </div>
    </section>

    <section>
      <div class="tabela-container">
        <div class="tabela-scroll">
          <div class="linha" style="background-color: #52b69a; color: white; font-weight: 600; margin-bottom: 15px;">
            <div class="coluna">Modelo</div>
            <div class="coluna">Placa</div>
            <div class="coluna">Serviço</div>
            <div class="coluna">Valor</div>
            <div class="coluna">Oficina</div>
            <div class="coluna">Hora</div>
            <div class="coluna">Data</div>
            <div class="coluna">Ações</div>
          </div>
          <div id="tabela"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal de Cadastro -->
  <div id="modalCadastro" class="modal-overlay hidden">
    <div class="modal-container">
      <div class="modal-header">
        <h2>Cadastrar Manutenção</h2>
        <button class="modal-close" onclick="fecharModal()">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      
      <form id="formCadastro" class="modal-form">
        <div class="form-group">
          <label for="modelo">
            <i class="fa-solid fa-car"></i>
            Modelo *
          </label>
          <input type="text" id="modelo" name="modelo" placeholder="Ex: Sandero" required>
        </div>

        <div class="form-group">
          <label for="placa">
            <i class="fa-solid fa-id-card"></i>
            Placa *
          </label>
          <input type="text" id="placa" name="placa" placeholder="Ex: ABC-1234" required>
        </div>

        <div class="form-group">
          <label for="servico">
            <i class="fa-solid fa-wrench"></i>
            Serviço *
          </label>
          <input type="text" id="servico" name="servico" placeholder="Ex: Troca de óleo" required>
        </div>

        <div class="form-group">
          <label for="valor">
            <i class="fa-solid fa-dollar-sign"></i>
            Valor *
          </label>
          <input type="number" id="valor" name="valor" placeholder="Ex: 350.00" step="0.01" required>
        </div>

        <div class="form-group">
          <label for="oficina">
            <i class="fa-solid fa-building"></i>
            Oficina *
          </label>
          <input type="text" id="oficina" name="oficina" placeholder="Ex: Mecânica do Tião" required>
        </div>

        <div class="form-group">
          <label for="hora">
            <i class="fa-solid fa-clock"></i>
            Hora *
          </label>
          <input type="time" id="hora" name="hora" required>
        </div>

        <div class="form-group">
          <label for="data">
            <i class="fa-solid fa-calendar"></i>
            Data *
          </label>
          <input type="date" id="data" name="data" required>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-cancelar" onclick="fecharModal()">
            <i class="fa-solid fa-times"></i>
            Cancelar
          </button>
          <button type="submit" class="btn-salvar">
            <i class="fa-solid fa-check"></i>
            Cadastrar
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const apiUrl = "/api/manutencoes";

    async function carregarTabela() {
      try {
        const tabela = document.getElementById("tabela");
        tabela.innerHTML = "<div class='linha'><div class='coluna' style='grid-column: 1 / -1; text-align: center;'>Carregando...</div></div>";
        
        const res = await fetch(apiUrl);
        
        if (!res.ok) {
          throw new Error(`Erro ${res.status}: ${res.statusText}`);
        }
        
        const dados = await res.json();

        if (!dados || dados.length === 0) {
          tabela.innerHTML = "<div class='linha'><div class='coluna' style='grid-column: 1 / -1; text-align: center;'>Nenhuma manutenção cadastrada</div></div>";
          return;
        }

        tabela.innerHTML = "";
        dados.forEach(item => {
          const linha = document.createElement("div");
          linha.classList.add("linha");
          
          // Formatar valor para exibição
          const valorFormatado = typeof item.valor === 'number' 
            ? item.valor.toFixed(2).replace('.', ',') 
            : item.valor;
          
          // Formatar data
          const dataFormatada = item.data 
            ? new Date(item.data + 'T00:00:00').toLocaleDateString('pt-BR')
            : 'N/A';
          
          linha.innerHTML = `
            <div class="coluna">${item.modelo || 'N/A'}</div>
            <div class="coluna">${item.placa || 'N/A'}</div>
            <div class="coluna">${item.servico || 'N/A'}</div>
            <div class="coluna">R$ ${valorFormatado}</div>
            <div class="coluna">${item.oficina || 'N/A'}</div>
            <div class="coluna">${item.hora || 'N/A'}</div>
            <div class="coluna">${dataFormatada}</div>
            <div class="coluna acoes-coluna">
              <button class="btn-acao btn-excluir" onclick="removerManutencao(${item.id})" title="Excluir">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          `;
          tabela.appendChild(linha);
        });
      } catch (erro) {
        console.error("Erro ao carregar tabela:", erro);
        const tabela = document.getElementById("tabela");
        tabela.innerHTML = `<div class='linha'><div class='coluna' style='grid-column: 1 / -1; text-align: center; color: red;'>Erro ao carregar dados: ${erro.message}</div></div>`;
      }
    }

    // Funções do Modal
    function abrirModal() {
      document.getElementById('modalCadastro').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function fecharModal() {
      document.getElementById('modalCadastro').classList.add('hidden');
      document.body.style.overflow = 'auto';
      document.getElementById('formCadastro').reset();
    }

    // Fechar modal ao clicar fora
    document.getElementById('modalCadastro').addEventListener('click', function(e) {
      if (e.target === this) {
        fecharModal();
      }
    });

    // Submissão do formulário
    document.getElementById('formCadastro').addEventListener('submit', async function(e) {
      e.preventDefault();

      const modelo = document.getElementById("modelo").value.trim();
      const placa = document.getElementById("placa").value.trim();
      const servico = document.getElementById("servico").value.trim();
      const valor = document.getElementById("valor").value;
      const oficina = document.getElementById("oficina").value.trim();
      const hora = document.getElementById("hora").value;
      const data = document.getElementById("data").value;

      // Validação
      if (!modelo || !placa || !servico || !valor || !oficina || !hora || !data) {
        alert("Por favor, preencha todos os campos!");
        return;
      }

      const nova = {
        modelo,
        placa,
        servico,
        valor: parseFloat(valor),
        oficina,
        hora,
        data
      };

      try {
        const res = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(nova)
        });

        const resultado = await res.json();

        if (res.ok) {
          alert("Manutenção cadastrada com sucesso!");
          fecharModal();
          carregarTabela();
        } else {
          alert(`Erro ao cadastrar manutenção: ${resultado.erro || resultado.detalhes || 'Erro desconhecido'}`);
        }
      } catch (erro) {
        console.error("Erro ao salvar manutenção:", erro);
        alert(`Erro ao cadastrar manutenção: ${erro.message}`);
      }
    });

    async function removerManutencao(id) {
      if (!confirm("Deseja remover esta manutenção?")) return;
      
      try {
        const res = await fetch(`${apiUrl}/${id}`, { method: "DELETE" });
        const resultado = await res.json();
        
        if (res.ok) {
          alert("Removida com sucesso!");
          carregarTabela();
        } else {
          alert(`Erro ao remover: ${resultado.erro || resultado.detalhes || 'Erro desconhecido'}`);
        }
      } catch (erro) {
        console.error("Erro ao remover manutenção:", erro);
        alert(`Erro ao remover: ${erro.message}`);
      }
    }

    // Carregar tabela ao carregar a página
    carregarTabela();
  </script>
</body>

</html>
