<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RotaGestor - Manutenção</title>
  <link rel="stylesheet" href="./styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <link rel="icon" href="../../../../public/assets/logo/Icon.svg">
</head>

<body p-0 m-0>
  <nav>
    <div class="logo">
      <img src="assets/Logo.svg">
    </div>
    <div class="navbar">
      <a href="/"><i class="icon fa-solid fa-house"></i>Início</a>
      <a href="/combustivel"><i class="icon fa-solid fa-gas-pump"></i>Combustivel</a>
      <a href="#"><i class="icon fa-solid fa-wrench"></i>Manutenção</a>
      <a href="/veiculos"><i class="icon fa-solid fa-car"></i> Veículos</a>
      <a href="/pessoas"><i class="icon fa-solid fa-user"></i>Pessoas</a>
    </div>
  </nav>

  <main>
    <header>
      <h1>Manutenções</h1>

      <div class="account-header">
        <div>
          <i class="fa-solid fa-user"></i>
          <span onclick="window.location.href='../../../../index.html'">Sair</span>
        </div>
        <i class="fa-solid fa-gear"></i>
        <i class="fa-solid fa-bell"></i>
      </div>
    </header>

    <section>
      <div class="filtro-container">
        <div class="filtro-item">
          <label>Modelo</label>
          <input type="text" id="filtroModelo" placeholder="Sandero">
        </div>

        <div class="filtro-item">
          <label>Placa</label>
          <input type="text" id="filtroPlaca" placeholder="AB4C-4D5H">
        </div>

        <div class="filtro-item">
          <label>Serviço</label>
          <input type="text" id="filtroServico" placeholder="Ex: Troca de óleo">
        </div>

        <div class="filtro-item">
          <label>Local</label>
          <input type="text" id="filtroLocal" placeholder="Ex: Mecânica do Tião">
        </div>

        <div class="filtro-item">
          <label>Data</label>
          <input type="date" id="filtroData">
        </div>

        <div class="filtro-item">
          <button class="btn" id="btnLimparFiltros" onclick="limparFiltros()" title="Limpar filtros">
            <i class="fa-solid fa-eraser"></i>
            Limpar
          </button>
        </div>

        <div class="filtro-item">
          <button class="btn" id="btnCadastrar" onclick="abrirModal()">
            <img src="assets/document-icon.svg" alt="Documento" class="">
            Cadastrar
          </button>
        </div>
      </div>
    </section>

    <section>
      <div class="tabela-container">
        <div class="tabela-scroll">
          <div class="linha" style="background-color: #52b69a; color: white; font-weight: 600; margin-bottom: 15px;">
            <div class="coluna">Modelo</div>
            <div class="coluna">Placa</div>
            <div class="coluna">Serviço</div>
            <div class="coluna">Valor</div>
            <div class="coluna">Oficina</div>
            <div class="coluna">Hora</div>
            <div class="coluna">Data</div>
            <div class="coluna">Ações</div>
          </div>
          <div id="tabela"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal de Cadastro -->
  <div id="modalCadastro" class="modal-overlay hidden">
    <div class="modal-container">
      <div class="modal-header">
        <h2>Cadastrar Manutenção</h2>
        <button class="modal-close" onclick="fecharModal()">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      
      <form id="formCadastro" class="modal-form">
        <div class="form-group">
          <label for="modelo">
            <i class="fa-solid fa-car"></i>
            Modelo *
          </label>
          <input type="text" id="modelo" name="modelo" placeholder="Ex: Sandero" required>
        </div>

        <div class="form-group">
          <label for="placa">
            <i class="fa-solid fa-id-card"></i>
            Placa *
          </label>
          <input type="text" id="placa" name="placa" placeholder="Ex: ABC-1234" required>
        </div>

        <div class="form-group">
          <label for="servico">
            <i class="fa-solid fa-wrench"></i>
            Serviço *
          </label>
          <input type="text" id="servico" name="servico" placeholder="Ex: Troca de óleo" required>
        </div>

        <div class="form-group">
          <label for="valor">
            <i class="fa-solid fa-dollar-sign"></i>
            Valor *
          </label>
          <input type="number" id="valor" name="valor" placeholder="Ex: 350.00" step="0.01" required>
        </div>

        <div class="form-group">
          <label for="oficina">
            <i class="fa-solid fa-building"></i>
            Oficina *
          </label>
          <input type="text" id="oficina" name="oficina" placeholder="Ex: Mecânica do Tião" required>
        </div>

        <div class="form-group">
          <label for="hora">
            <i class="fa-solid fa-clock"></i>
            Hora *
          </label>
          <input type="time" id="hora" name="hora" required>
        </div>

        <div class="form-group">
          <label for="data">
            <i class="fa-solid fa-calendar"></i>
            Data *
          </label>
          <input type="date" id="data" name="data" required>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-cancelar" onclick="fecharModal()">
            <i class="fa-solid fa-times"></i>
            Cancelar
          </button>
          <button type="submit" class="btn-salvar">
            <i class="fa-solid fa-check"></i>
            Cadastrar
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const apiUrl = "/api/manutencoes";

    // Variável global para armazenar todas as manutenções
    window.todasManutencoes = [];

    // Função para formatar data
    function formatarData(dataString) {
      if (!dataString) return 'N/A';
      const data = new Date(dataString + 'T00:00:00');
      return data.toLocaleDateString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    }

    // Função para filtrar manutenções (global)
    window.filtrarManutencoes = function() {
      const filtroModelo = document.getElementById('filtroModelo').value.toLowerCase().trim();
      const filtroPlaca = document.getElementById('filtroPlaca').value.toLowerCase().trim();
      const filtroServico = document.getElementById('filtroServico').value.toLowerCase().trim();
      const filtroLocal = document.getElementById('filtroLocal').value.toLowerCase().trim();
      const filtroData = document.getElementById('filtroData').value;

      let manutencoesFiltradas = window.todasManutencoes.filter(manutencao => {
        // Filtro por modelo
        if (filtroModelo && !manutencao.modelo?.toLowerCase().includes(filtroModelo)) {
          return false;
        }

        // Filtro por placa
        if (filtroPlaca && !manutencao.placa?.toLowerCase().includes(filtroPlaca)) {
          return false;
        }

        // Filtro por serviço
        if (filtroServico && !manutencao.servico?.toLowerCase().includes(filtroServico)) {
          return false;
        }

        // Filtro por local/oficina
        if (filtroLocal && !manutencao.oficina?.toLowerCase().includes(filtroLocal)) {
          return false;
        }

        // Filtro por data
        if (filtroData) {
          const dataManutencao = manutencao.data ? new Date(manutencao.data + 'T00:00:00') : null;
          const dataFiltro = new Date(filtroData);
          
          if (!dataManutencao) return false;
          
          // Comparar apenas a data (ignorar hora)
          const dataManutencaoFormatada = new Date(dataManutencao.getFullYear(), dataManutencao.getMonth(), dataManutencao.getDate());
          const dataFiltroFormatada = new Date(dataFiltro.getFullYear(), dataFiltro.getMonth(), dataFiltro.getDate());
          
          if (dataManutencaoFormatada.getTime() !== dataFiltroFormatada.getTime()) {
            return false;
          }
        }

        return true;
      });

      exibirManutencoes(manutencoesFiltradas);
    };

    // Função para exibir manutenções na tabela
    function exibirManutencoes(manutencoes) {
      const tabela = document.getElementById('tabela');

      // Limpar tabela antes de adicionar novos dados
      tabela.innerHTML = '';

      // Verificar se há manutenções
      if (!manutencoes || manutencoes.length === 0) {
        tabela.innerHTML = '<div class="linha"><div class="coluna" style="grid-column: 1 / -1; text-align: center;">Nenhuma manutenção encontrada</div></div>';
        return;
      }

      // Iterar sobre as manutenções
      manutencoes.forEach(item => {
        const linha = document.createElement('div');
        linha.classList.add('linha');

        // Formatar valor para exibição
        const valorFormatado = typeof item.valor === 'number' 
          ? item.valor.toFixed(2).replace('.', ',') 
          : item.valor || '0,00';
        
        // Formatar data
        const dataFormatada = formatarData(item.data);

        linha.innerHTML = `
          <div class="coluna">${item.modelo || 'N/A'}</div>
          <div class="coluna">${item.placa || 'N/A'}</div>
          <div class="coluna">${item.servico || 'N/A'}</div>
          <div class="coluna">R$ ${valorFormatado}</div>
          <div class="coluna">${item.oficina || 'N/A'}</div>
          <div class="coluna">${item.hora || 'N/A'}</div>
          <div class="coluna">${dataFormatada}</div>
          <div class="coluna acoes-coluna">
            <button class="btn-acao btn-excluir" onclick="removerManutencao(${item.id})" title="Excluir">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        `;

        tabela.appendChild(linha);
      });
    }

    // Função para limpar filtros (global)
    window.limparFiltros = function() {
      document.getElementById('filtroModelo').value = '';
      document.getElementById('filtroPlaca').value = '';
      document.getElementById('filtroServico').value = '';
      document.getElementById('filtroLocal').value = '';
      document.getElementById('filtroData').value = '';
      window.filtrarManutencoes();
    };

    // Função para carregar dados da API
    async function carregarDados() {
      try {
        const res = await fetch(apiUrl);
        
        if (!res.ok) {
          throw new Error(`Erro ${res.status}: ${res.statusText}`);
        }
        
        const dados = await res.json();

        // Armazenar todas as manutenções
        window.todasManutencoes = dados || [];
        
        // Exibir todas as manutenções inicialmente
        window.filtrarManutencoes();
      } catch (erro) {
        console.error("Erro ao carregar dados:", erro);
        const tabela = document.getElementById('tabela');
        tabela.innerHTML = '<div class="linha"><div class="coluna" style="grid-column: 1 / -1; text-align: center; color: red;">Erro ao carregar dados. Verifique a conexão com o servidor.</div></div>';
      }
    }

    // Funções do Modal
    function abrirModal() {
      document.getElementById('modalCadastro').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function fecharModal() {
      document.getElementById('modalCadastro').classList.add('hidden');
      document.body.style.overflow = 'auto';
      document.getElementById('formCadastro').reset();
    }

    // Fechar modal ao clicar fora
    document.getElementById('modalCadastro').addEventListener('click', function(e) {
      if (e.target === this) {
        fecharModal();
      }
    });

    // Submissão do formulário
    document.getElementById('formCadastro').addEventListener('submit', async function(e) {
      e.preventDefault();

      const modelo = document.getElementById("modelo").value.trim();
      const placa = document.getElementById("placa").value.trim();
      const servico = document.getElementById("servico").value.trim();
      const valor = document.getElementById("valor").value;
      const oficina = document.getElementById("oficina").value.trim();
      const hora = document.getElementById("hora").value;
      const data = document.getElementById("data").value;

      // Validação
      if (!modelo || !placa || !servico || !valor || !oficina || !hora || !data) {
        alert("Por favor, preencha todos os campos!");
        return;
      }

      const nova = {
        modelo,
        placa,
        servico,
        valor: parseFloat(valor),
        oficina,
        hora,
        data
      };

      try {
        const res = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(nova)
        });

        const resultado = await res.json();

        if (res.ok) {
          alert("Manutenção cadastrada com sucesso!");
          fecharModal();
          carregarDados();
        } else {
          alert(`Erro ao cadastrar manutenção: ${resultado.erro || resultado.detalhes || 'Erro desconhecido'}`);
        }
      } catch (erro) {
        console.error("Erro ao salvar manutenção:", erro);
        alert(`Erro ao cadastrar manutenção: ${erro.message}`);
      }
    });

    async function removerManutencao(id) {
      if (!confirm("Deseja remover esta manutenção?")) return;
      
      try {
        const res = await fetch(`${apiUrl}/${id}`, { method: "DELETE" });
        const resultado = await res.json();
        
        if (res.ok) {
          alert("Removida com sucesso!");
          carregarDados();
        } else {
          alert(`Erro ao remover: ${resultado.erro || resultado.detalhes || 'Erro desconhecido'}`);
        }
      } catch (erro) {
        console.error("Erro ao remover manutenção:", erro);
        alert(`Erro ao remover: ${erro.message}`);
      }
    }

    // Adicionar event listeners aos campos de filtro
    document.addEventListener('DOMContentLoaded', function() {
      const filtroModelo = document.getElementById('filtroModelo');
      const filtroPlaca = document.getElementById('filtroPlaca');
      const filtroServico = document.getElementById('filtroServico');
      const filtroLocal = document.getElementById('filtroLocal');
      const filtroData = document.getElementById('filtroData');

      if (filtroModelo) {
        filtroModelo.addEventListener('input', window.filtrarManutencoes);
      }

      if (filtroPlaca) {
        filtroPlaca.addEventListener('input', window.filtrarManutencoes);
      }

      if (filtroServico) {
        filtroServico.addEventListener('input', window.filtrarManutencoes);
      }

      if (filtroLocal) {
        filtroLocal.addEventListener('input', window.filtrarManutencoes);
      }

      if (filtroData) {
        filtroData.addEventListener('change', window.filtrarManutencoes);
      }
    });

    // Carregar dados ao carregar a página
    carregarDados();
  </script>
</body>

</html>
